<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - KJC VOX</title>
    <!-- Tailwind CSS CDN for utility classes. This provides a robust base for styling. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons (e.g., user, envelope, lock). Essential for matching the screenshot's input field icons. -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Google Fonts - Inter. Used for consistent typography as requested. -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for the entire page */
        body {
            font-family: 'Inter', sans-serif; /* Apply Inter font globally */
            margin: 0;
            padding: 0;
            background-color: #ffffff; /* Changed to white background as requested */
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensures the body takes at least the full viewport height */
        }

        /* Navigation Bar Styling */
        .navbar {
            background-color: #ffffff; /* White background for the navbar */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
            padding: 1rem 2.5rem; /* Padding on all sides, adjusted for screenshot spacing */
            display: flex;
            justify-content: space-between; /* Distributes items to ends */
            align-items: center; /* Vertically centers items */
        }

        .navbar .logo {
            display: flex;
            align-items: center;
        }

        .navbar .logo img {
            height: 2.5rem; /* 40px */
            width: 2.5rem; /* 40px */
            border-radius: 50%; /* Circular image */
            margin-right: 0.5rem;
        }

        .navbar .logo-text {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* Dark gray text */
        }

        /* Desktop Navigation Links */
        .navbar .nav-links {
            display: flex; /* Flex container for navigation links */
            gap: 2rem; /* Space between links */
        }

        .navbar .nav-links a {
            color: #4b5563; /* Gray text for links */
            text-decoration: none; /* No underline */
            font-weight: 500;
            transition: color 0.2s ease-in-out; /* Smooth color transition on hover */
        }

        .navbar .nav-links a:hover {
            color: #2563eb; /* Blue on hover */
        }

        /* Mobile Menu Button (Hidden by default) */
        .mobile-menu-button {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #4b5563;
            cursor: pointer;
        }

        /* Mobile Menu (Hidden by default) */
        .mobile-menu {
            display: none;
            flex-direction: column;
            width: 100%;
            padding: 1rem 0;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
        }

        .mobile-menu a {
            padding: 0.75rem 2.5rem;
            color: #4b5563;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .mobile-menu a:hover {
            background-color: #f3f4f6;
            color: #2563eb;
        }

        /* Main Content Area - Centers the Forgot Password Form */
        .main-content {
            flex-grow: 1; /* Allows this div to expand and push the footer down */
            display: flex;
            justify-content: center; /* Horizontally center the form */
            align-items: center; /* Vertically center the form */
            padding: 2rem 1rem; /* Reduced padding for better fit */
        }

        /* Forgot Password Container - The main card holding both panels */
        .forgot-password-container {
            display: flex;
            background-color: #fff; /* White background for the entire card */
            border-radius: 1rem; /* Rounded corners for the whole card */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow for depth */
            overflow: hidden; /* Ensures internal content respects border-radius */
            max-width: 800px; /* Reduced max-width for better fit */
            width: 100%;
        }

        /* Left Panel Styling */
        .left-panel {
            flex: 1; /* Takes 1 unit of flexible space, making it smaller */
            background-color: #ffffff; /* Changed to white background as requested */
            color: #1f2937; /* Dark text color for readability on white background */
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-top-left-radius: 1rem; /* Matches parent border radius */
            border-bottom-left-radius: 1rem; /* Matches parent border radius */
        }

        .left-panel .title {
            font-size: 1.5rem; /* Adjusted font size to fit on one line as requested */
            font-weight: 700; /* font-bold */
            margin-bottom: 0.5rem;
            white-space: nowrap; /* Ensures text stays on one line */
            color: #ff9900; /* Changed to orange color from stepper as requested */
        }

        .left-panel .subtitle {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* Gray text for readability on white */
            margin-bottom: 1.5rem;
        }

        .left-panel .image-section {
            margin: 2rem 0;
        }

        .left-panel .security-image {
            max-width: 100%;
            height: auto;
            max-height: 200px; /* Added max-height for better control */
            border-radius: 0.5rem; /* Slightly rounded corners for the image */
            object-fit: contain; /* Ensures image maintains aspect ratio */
        }

        .left-panel .description {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* Gray text for readability on white */
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .left-panel .login-prompt {
            /* This section now has a distinct dark background */
            background-color: #2d3748; /* Dark background color as requested */
            color: #fff; /* White text color for this section */
            padding: 1.5rem;
            width: calc(100% + 4rem); /* Extend to cover full width including parent padding */
            margin-left: -2rem; /* Pull left to align with parent edge */
            margin-right: -2rem; /* Pull right to align with parent edge */
            border-bottom-left-radius: 1rem; /* Match parent border radius */
            margin-top: auto; /* Pushes content to the bottom of the panel */
            padding-top: 1.5rem;
        }

        .left-panel .login-prompt p {
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            color: #fff; /* Ensure text is white on dark background */
        }

        .left-panel .login-button {
            background-color: #ffffff; /* White background as requested */
            color: #2563eb; /* Blue text as requested */
            border: 1px solid #2563eb; /* Blue border as requested */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease; /* Transition for both */
            cursor: pointer;
        }

        .left-panel .login-button:hover {
            background-color: #eff6ff; /* Light blue background on hover */
            color: #1d4ed8; /* Darker blue text on hover */
        }

        /* Right Panel Styling */
        .right-panel {
            flex: 2; /* Takes 2 units of flexible space, making it wider than the left panel */
            background-color: #2d3748; /* Dark background color, matching left for seamless look */
            color: #fff;
            padding: 2rem; /* Reduced padding */
            display: flex;
            flex-direction: column;
            border-top-right-radius: 1rem; /* Matches parent border radius */
            border-bottom-right-radius: 1rem; /* Matches parent border radius */
        }

        /* Stepper Styling */
        .modern-stepper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            width: 100%;
            position: relative;
        }

        .step-container {
            display: flex;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
        }

        .circle {
            background-color: #cbd5e0;
            color: #4a5568;
            width: 2rem; /* Reduced size */
            height: 2rem; /* Reduced size */
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.875rem; /* Smaller font */
        }

        .label {
            margin-top: 0.5rem;
            font-size: 0.75rem; /* Smaller font for labels */
            color: #a0aec0;
            white-space: nowrap;
        }

        /* Connecting line between steps */
        .step-line {
            height: 2px;
            background-color: #e2e8f0;
            flex: 1;
            margin: 0 0.5rem;
            z-index: 1;
            position: relative;
            top: -1rem;
        }

        /* Active Step */
        .step.active .circle {
            background-color: #ff9900; /* Orange color */
            color: white;
        }
        .step.active .label {
            color: #ff9900; /* Orange color */
        }

        /* Completed Step */
        .step.completed .circle {
            background-color: #ff9900; /* Orange color */
            color: white;
        }
        .step.completed .label {
            color: #ff9900; /* Orange color */
        }

        .step-line.active {
            background-color: #ff9900; /* Orange color */
        }

        /* Form Step Styling (for the actual input fields and buttons) */
        .form-step {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.25rem; /* Reduced gap */
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 0.75rem; /* Smaller font */
            color: #e5e7eb; /* Lighter color */
            margin-bottom: 0.5rem;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-wrapper .icon {
            position: absolute;
            left: 1rem;
            color: #9ca3af; /* Lighter icon color */
            font-size: 1rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem; /* Left padding for icon */
            background-color: #ffffff; /* White background */
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 0.5rem;
            color: #1f2937; /* Dark text color */
            font-size: 0.875rem; /* Smaller font */
            outline: none; /* Remove default outline */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-input[readonly] {
            background-color: #f3f4f6; /* Light gray for readonly */
            cursor: not-allowed;
        }

        .form-input::placeholder {
            color: #9ca3af; /* Lighter placeholder */
        }

        .form-input:focus {
            border-color: #2563eb; /* blue-700 on focus */
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5); /* blue-700 with opacity for focus ring */
        }

        /* Password toggle eye icon */
        .password-toggle {
            position: absolute;
            right: 1rem;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Action Button Styling (Send Code, Verify Code, Reset Password) */
        .action-button {
            width: 100%;
            padding: 0.75rem; /* Reduced padding */
            background-color: #ff9900; /* Orange color */
            color: #fff;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem; /* Smaller font */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-top: 1rem; /* Reduced margin */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow for buttons */
        }

        /* Hover Effects for Action Buttons */
        .action-button:hover {
            background-color: #e68a00; /* Darker orange on hover */
            transform: translateY(-2px); /* Slight lift effect */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); /* Enhanced shadow on hover */
        }

        /* Utility class to hide elements */
        .hidden {
            display: none !important;
        }

        /* Footer Styling */
        .footer {
            background-color: #1f2937; /* Dark gray background */
            color: #ffffff;
            text-align: center;
            padding: 1rem;
            margin-top: auto; /* Pushes the footer to the bottom */
            font-size: 0.75rem; /* Smaller font */
        }

        /* Responsive Adjustments for smaller screens */
        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
                position: relative;
            }

            /* Hide desktop nav links */
            .navbar .nav-links {
                display: none;
            }

            /* Show mobile menu button */
            .mobile-menu-button {
                display: block;
            }

            /* Show mobile menu when active */
            .mobile-menu.active {
                display: flex;
            }

            /* Stack panels vertically on mobile */
            .forgot-password-container {
                flex-direction: column;
                margin: 1rem;
                max-width: 100%;
            }

            .left-panel, .right-panel {
                border-radius: 0;
                padding: 1.5rem;
            }

            /* Re-apply specific border radii for top/bottom when stacked */
            .left-panel {
                border-top-left-radius: 0.5rem;
                border-top-right-radius: 0.5rem;
            }

            .right-panel {
                border-bottom-left-radius: 0.5rem;
                border-bottom-right-radius: 0.5rem;
            }

            /* Adjust image size for mobile */
            .left-panel .security-image {
                max-height: 150px;
            }

            /* Adjust stepper for mobile */
            .modern-stepper {
                margin-bottom: 1.5rem;
            }

            .circle {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.75rem;
            }

            .label {
                font-size: 0.65rem;
            }

            /* Adjust login prompt for mobile */
            .left-panel .login-prompt {
                width: 100%;
                margin-left: 0;
                margin-right: 0;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }
        }

        @media (max-width: 480px) {
            .left-panel .title {
                font-size: 1.25rem;
            }
            
            .left-panel .security-image {
                max-height: 120px;
            }
            
            .form-input {
                padding-left: 2.5rem; /* Reduce padding for smaller screens */
            }
            
            .input-wrapper .icon {
                left: 0.75rem;
                font-size: 0.875rem;
            }
            
            .password-toggle {
                right: 0.75rem;
                font-size: 0.875rem;
            }
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            z-index: 1000;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease-out;
        }

        .alert-error {
            background-color: #fee;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        .alert-success {
            background-color: #f0fff4;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }

        .alert-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: auto;
            color: inherit;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar">
    <div class="logo">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTXuH55vOVHO2LCF7rxvEYAfpEZqj3qvRuKnw&s" alt="Logo">
        <h1 class="text-3xl font-extrabold font-[Inter]">
            <span style="color: #1f2937;">KJC</span>
            <span style="color: #fbbf24;">VOX</span>
        </h1>
    </div>

    <!-- Desktop Navigation Links -->
    <div class="nav-links">
        <a href="#">Home</a>
        <a href="#">Login</a>
    </div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-button" id="mobileMenuButton">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Menu (Hidden by default) -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="#">Home</a>
        <a href="#">Login</a>
    </div>
</nav>

<!-- Main Content Area -->
<div class="main-content">
    <div class="forgot-password-container">
        <!-- Left Panel -->
        <div class="left-panel">
            <h2 class="title">Forgot Password ?</h2>
            <p class="subtitle">Secure access for students, faculties & admins</p>
            <div class="image-section">
                <img src="images/Lock-IN.png" alt="Security Illustration" class="security-image">
            </div>
            <p class="description">A private, secure platform for honest feedback and academic reflection</p>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <!-- Stepper Component -->
            <div class="modern-stepper">
                <div class="step-container">
                    <div id="step1" class="step completed">
                        <div class="circle">1</div>
                        <div class="label">Reset Password</div>
                    </div>
                    <div id="line1-2" class="step-line"></div>
                </div>
                <div class="step-container">
                    <div id="step2" class="step active">
                        <div class="circle">2</div>
                        <div class="label">Verification Code</div>
                    </div>
                    <div id="line2-3" class="step-line"></div>
                </div>
                <div class="step-container">
                    <div id="step3" class="step">
                        <div class="circle">3</div>
                        <div class="label">Password Set</div>
                    </div>
                </div>
            </div>

            <!-- Form Steps -->
            <!-- Step 1 -->
            <div id="formStep1" class="form-step">
                <div class="input-group">
                    <label for="rollno">Roll Number</label>
                    <div class="input-wrapper">
                        <i class="fas fa-id-card icon"></i>
                        <input type="text" id="rollno" placeholder="Enter your roll number" class="form-input" required>
                    </div>
                </div>
                <div class="input-group">
                    <label for="name">Name</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user icon"></i>
                        <input type="text" id="name" class="form-input" readonly>
                    </div>
                </div>
                <div class="input-group">
                    <label for="email">Email</label>
                    <div class="input-wrapper">
                        <i class="fas fa-envelope icon"></i>
                        <input type="email" id="email" class="form-input" readonly>
                    </div>
                </div>
                <button class="action-button send-code-button" onclick="sendCode()">Send Code</button>
            </div>

            <!-- Step 2 -->
            <div id="formStep2" class="form-step hidden">
                <div class="input-group">
                    <label for="rollno2">Roll Number</label>
                    <div class="input-wrapper">
                        <i class="fas fa-id-card icon"></i>
                        <input type="text" id="rollno2" class="form-input" readonly>
                    </div>
                </div>
                <div class="input-group">
                    <label for="name2">Name</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user icon"></i>
                        <input type="text" id="name2" class="form-input" readonly>
                    </div>
                </div>
                <div class="input-group">
                    <label for="email2">Email</label>
                    <div class="input-wrapper">
                        <i class="fas fa-envelope icon"></i>
                        <input type="email" id="email2" class="form-input" readonly>
                    </div>
                </div>
                <div class="input-group">
                    <label for="verificationCode">Verification Code</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock icon"></i>
                        <input type="text" id="verificationCode" placeholder="Enter verification code" class="form-input" required>
                    </div>
                </div>
                <button class="action-button verify-code-button" onclick="verifyCode()">Verify Code</button>
            </div>

            <!-- Step 3 -->
            <div id="formStep3" class="form-step hidden">
                <div class="input-group">
                    <label for="email3">Email</label>
                    <div class="input-wrapper">
                        <i class="fas fa-envelope icon"></i>
                        <input type="email" id="email3" class="form-input" readonly>
                    </div>
                </div>
                <div class="input-group">
                    <label for="newPassword">New Password</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock icon"></i>
                        <input type="password" id="newPassword" placeholder="Enter new password" class="form-input" required>
                        <i class="fas fa-eye password-toggle" id="toggleNewPassword"></i>
                    </div>
                </div>
                <div class="input-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock icon"></i>
                        <input type="password" id="confirmPassword" placeholder="Confirm new password" class="form-input" required>
                        <i class="fas fa-eye password-toggle" id="toggleConfirmPassword"></i>
                    </div>
                </div>
                <button class="action-button reset-password-button" onclick="resetPassword()">Reset Password</button>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <p>&copy; KJC VOX. All rights reserved.</p>
</footer>

<script>
    let currentStep = 1;
    let studentData = null;

    // Initialize form
    document.addEventListener('DOMContentLoaded', function() {
        updateFormStep();
        document.getElementById('rollno').addEventListener('blur', verifyRollNumber);

        // Password visibility toggles
        document.getElementById('toggleNewPassword').addEventListener('click', function() {
            togglePasswordVisibility('newPassword', this);
        });
        document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
            togglePasswordVisibility('confirmPassword', this);
        });
    });

    function updateFormStep() {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(step => {
            step.classList.add('hidden');
        });

        // Show current step
        document.getElementById(`formStep${currentStep}`).classList.remove('hidden');
        updateStepper();
    }

    function updateStepper() {
        // Reset all steps
        document.querySelectorAll('.step').forEach(step => {
            step.classList.remove('active', 'completed');
        });
        document.querySelectorAll('.step-line').forEach(line => {
            line.classList.remove('active');
        });

        // Update based on current step
        if (currentStep >= 1) {
            document.getElementById('step1').classList.add('active');
        }
        if (currentStep >= 2) {
            document.getElementById('step1').classList.add('completed');
            document.getElementById('line1-2').classList.add('active');
            document.getElementById('step2').classList.add('active');
        }
        if (currentStep >= 3) {
            document.getElementById('step2').classList.add('completed');
            document.getElementById('line2-3').classList.add('active');
            document.getElementById('step3').classList.add('active');
        }
    }

    async function verifyRollNumber() {
        const rollNo = document.getElementById('rollno').value.trim();
        if (!rollNo) {
            showError('Please enter your roll number');
            return;
        }

        try {
            const response = await fetch('/api/reset/verify-rollno', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `rollno=${encodeURIComponent(rollNo)}`
            });

            const responseText = await response.text();

            // Check if response is JSON
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (parseError) {
                console.error('Server returned non-JSON response:', responseText);
                throw new Error('Server error: Invalid response format');
            }

            if (!response.ok) {
                throw new Error(data.error || 'Verification failed');
            }

            studentData = data;
            document.getElementById('name').value = data.name;
            document.getElementById('email').value = data.email;
            showSuccess('Student details verified successfully');

        } catch (error) {
            console.error('Error:', error);
            showError(error.message);
            document.getElementById('name').value = '';
            document.getElementById('email').value = '';
            studentData = null;
        }
    }

    async function sendCode() {
        const email = document.getElementById('email').value.trim();
        if (!email || !studentData) {
            showError('Please verify your roll number first');
            return;
        }

        try {
            // Check if user is registered
            const checkResponse = await fetch('/api/reset/check-registered', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `email=${encodeURIComponent(email)}`
            });

            const checkText = await checkResponse.text();
            let checkData;
            try {
                checkData = JSON.parse(checkText);
            } catch (parseError) {
                console.error('Server returned non-JSON response:', checkText);
                throw new Error('Server error: Invalid response format');
            }

            if (!checkResponse.ok || !checkData.registered) {
                throw new Error('No account found. Please register first.');
            }

            // Send verification code
            const codeResponse = await fetch('/api/reset/send-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `email=${encodeURIComponent(email)}`
            });

            const codeText = await codeResponse.text();
            let codeData;
            try {
                codeData = JSON.parse(codeText);
            } catch (parseError) {
                console.error('Server returned non-JSON response:', codeText);
                throw new Error('Server error: Invalid response format');
            }

            if (!codeResponse.ok) {
                throw new Error(codeData.message || 'Failed to send code');
            }

            showSuccess('Verification code sent to your email');
            currentStep = 2;
            updateFormStep();
            populateStep2();

        } catch (error) {
            console.error('Error:', error);
            showError(error.message);
        }
    }

    function populateStep2() {
        if (!studentData) return;

        document.getElementById('rollno2').value = studentData.rollnumber;
        document.getElementById('name2').value = studentData.name;
        document.getElementById('email2').value = studentData.email;
    }

    async function verifyCode() {
        const code = document.getElementById('verificationCode').value.trim();
        if (!code) {
            showError('Please enter the verification code');
            return;
        }

        if (code.length !== 6) {
            showError('Verification code must be 6 digits');
            return;
        }

        // For now, just proceed to step 3
        // In production, you would verify the code with backend
        showSuccess('Code verified successfully');
        currentStep = 3;
        updateFormStep();
        populateStep3();
    }

    function populateStep3() {
        if (!studentData) return;
        document.getElementById('email3').value = studentData.email;
    }

    async function resetPassword() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const email = document.getElementById('email3').value;
        const code = document.getElementById('verificationCode').value;

        if (!newPassword || !confirmPassword) {
            showError('Please enter and confirm your new password');
            return;
        }

        if (newPassword.length < 6) {
            showError('Password must be at least 6 characters long');
            return;
        }

        if (newPassword !== confirmPassword) {
            showError('Passwords do not match');
            return;
        }

        try {
            const response = await fetch('/api/reset/password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `email=${encodeURIComponent(email)}&code=${encodeURIComponent(code)}&newPassword=${encodeURIComponent(newPassword)}`
            });

            const responseText = await response.text();
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (parseError) {
                console.error('Server returned non-JSON response:', responseText);
                throw new Error('Server error: Invalid response format');
            }

            if (!response.ok) {
                throw new Error(data.message || 'Password reset failed');
            }

            showSuccess('Password reset successfully! Redirecting to login...');
            setTimeout(() => {
                window.location.href = '/login.html';
            }, 2000);

        } catch (error) {
            console.error('Error:', error);
            showError(error.message);
        }
    }

    function togglePasswordVisibility(fieldId, icon) {
        const field = document.getElementById(fieldId);
        const type = field.type === 'password' ? 'text' : 'password';
        field.type = type;
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    }

    function showError(message) {
        // Remove any existing alerts
        removeExistingAlerts();

        const alert = document.createElement('div');
        alert.className = 'alert alert-error';
        alert.innerHTML = `
            <i class="fas fa-exclamation-circle"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.remove()" class="alert-close">×</button>
        `;

        document.body.appendChild(alert);
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }

    function showSuccess(message) {
        // Remove any existing alerts
        removeExistingAlerts();

        const alert = document.createElement('div');
        alert.className = 'alert alert-success';
        alert.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.remove()" class="alert-close">×</button>
        `;

        document.body.appendChild(alert);
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }

    function removeExistingAlerts() {
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
    }
</script>
</body>
</html>